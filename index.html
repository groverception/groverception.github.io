<html>

<head>


    <script type="text/javascript">

        function fetchCenter() {
            
            const userAction = async () => {
                
                const pincode = document.querySelector("[id='pincode']").value || "";
                const date = document.querySelector("[id='date']").value || "";


                const response = await fetch(`https://api.cowin.gov.in/api/v2/appointment/sessions/public/calendarByPin?pincode=${pincode}&date=${date}`);
                const myJson = await response.json(); //extract JSON from the http response
                return myJson;
                // do something with myJson
            }

            userAction().then((result) => {
                
                console.log(result)
                if (result && result.centers) CreateTableFromJSON(result.centers);
                else CreateTableFromJSON([]);
            });

        }

        function CreateTableFromJSON(centers) {


            var eighteenAge= true;
            if (document.getElementById('age1').checked == true) {
                eighteenAge = true;
            } else {
                eighteenAge = false;
            }
            // EXTRACT VALUE FOR HTML HEADER. 
            // ('Book ID', 'Book Name', 'Category' and 'Price')
            var col = [];
            for (var i = 0; i < centers.length; i++) {
                for (var key in centers[i]) {
                    if (col.indexOf(key) === -1) {
                        col.push(key);
                    }
                }
            }
            // CREATE DYNAMIC TABLE.
            var table = document.createElement("table");
            // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.
            var tr = table.insertRow(-1);                   // TABLE ROW.
            for (var i = 0; i < col.length; i++) {
                var th = document.createElement("th");      // TABLE HEADER.
                th.innerHTML = col[i];
                tr.appendChild(th);
            }
            // ADD JSON DATA TO THE TABLE AS ROWS.
            for (var i = 0; i < centers.length; i++) {
                tr = table.insertRow(-1);
                for (var j = 0; j < col.length; j++) {
                    var tabCell = tr.insertCell(-1);
                    

                    //session based filtering
                    if (col[j] === "sessions") {
                        var sessions = JSON.parse(JSON.stringify(centers[i][col[j]]));
                        if (sessions.length) {
                            centers[i][col[j]] = [];
                            for (var k = 0; k < sessions.length; k++) {

                                if ((eighteenAge && sessions[k].min_age_limit < 45)||(!eighteenAge && sessions[k].min_age_limit >= 45)) {
                                    var slotDiv = document.createElement("div");
                                    var slotP = document.createElement("p");

                                    slotP.innerHTML = `available_capacity: ${sessions[k].available_capacity}  <br>  Date: ${sessions[k].date}   Age limit: ${sessions[k].min_age_limit}`;

                                    slotDiv.appendChild(slotP);
                                    centers[i][col[j]].push(slotDiv);
                                }
                            }
                        }
                        if (centers[i][col[j]].length == 0) tabCell.innerHTML = "<span>No slots for 18 years or above</span>";
                        else {
                            centers[i][col[j]].forEach(element => {
                                
                                tabCell.appendChild(element);
                            });
                        }
                    }

                    else tabCell.innerHTML = centers[i][col[j]];
                }
            }
            // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
            var divContainer = document.getElementById("showData");
            divContainer.innerHTML = "";
            divContainer.appendChild(table);
        }


    </script>
    <style>
        table{
            margin: auto;
        }
        div {
            /* Center the form on the page */
            margin: 0 auto;
            /* width: 500px; */
            /* Form outline */
            padding: 1em;
            border: 1px solid #CCC;
            border-radius: 1em;
            text-align: center;
        }

        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        div li+li {
            margin-top: 1em;
        }

        li div {
            text-align: center;
        }

        label {
            /* Uniform size & alignment */
            display: inline-block;
            width: 90px;
            text-align: right;
        }

        input,
        textarea {
            /* To make sure that all text fields have the same font settings
     By default, textareas have a monospace font */
            font: 1em sans-serif;

            /* Uniform text field size */
            width: 300px;
            box-sizing: border-box;

            /* Match form field borders */
            border: 1px solid #999;
        }

        input:focus,
        textarea:focus {
            /* Additional highlight for focused elements */
            border-color: #000;
        }

        textarea {
            /* Align multiline text fields with their labels */
            vertical-align: top;

            /* Provide space to type some text */
            height: 5em;
        }

        .button {
            /* Align buttons with the text fields */
            padding-left: 90px;
            /* same size as the label elements */
        }

        button {
            /* This extra margin represent roughly the same space as the space
     between the labels and their text fields */
            margin-left: .5em;
        }

        th,
        td,
        p,
        input {
            font: 14px Verdana;
        }

        table,
        th,
        td {
            border: solid 1px #DDD;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
        }

        th {
            font-weight: bold;
        }
    </style>

</head>


<body id="body">

    <div method="post">
        <ul>
            <li>
                <label for="name">Pin:</label>
                <input type="text" id="pincode" name="pincode" placeholder="Enter pin code" />
            </li>
            <li>
                <label for="mail">Date:</label>
                <input type="text" id="date" name="date" placeholder="Enter date in dd-mm-yyyy" />
            </li>
            <li>
                <div>
                    <p>Please select your age:</p>
                    <input type="radio" id="age1" name="age" value="18" checked>
                    <label for="age1">18 - 45</label><br>
                    <input type="radio" id="age2" name="age" value="45">
                    <label for="age2">45+</label><br>
                </div>
            </li>
            <li>
                <div>
                    <button id="fetchCenter" onClick="fetchCenter()"> Fetch Center </button>
                </div>

            </li>

            <li>
                <label for="msg">Center Details:</label>
                <p id="showData"></p>
            </li>
        </ul>
    </div>



</body>

<html>
